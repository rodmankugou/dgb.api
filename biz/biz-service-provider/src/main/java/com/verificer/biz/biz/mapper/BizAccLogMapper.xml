<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.verificer.biz.biz.mapper.BizAccLogMapper">

  <resultMap id="RefereeRstMap" type="com.verificer.biz.beans.vo.user.RefereeVo">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <result column="commission" jdbcType="DECIMAL" property="commission" />
    <result column="nickname" jdbcType="VARCHAR" property="nickname" />
    <result column="mobile" jdbcType="VARCHAR" property="mobile" />
    <result column="uid" jdbcType="VARCHAR" property="uid" />
  </resultMap>

  <sql id="refereeCond">
    <if test="accountId != null">
      and account_id = #{accountId}
    </if>
    <if test="opType != null">
      and op_type = #{opType}
    </if>
  </sql>

  <select id="pageReferee" resultMap="RefereeRstMap">
    select ref.op_amount as commission, u.nickname as nickname ,u.mobile as mobile ,u.uid as uid from
    (
      select * from account_log
      where  1=1
        <include refid="refereeCond"></include>
      order by id desc
      limit #{from},#{limit}
    ) as ref
    left join member_order mo on ref.attach_id = mo.id
    left join user u on mo.user_id = u.id

  </select>

  <select id="countReferee" resultType="int">
    select count(*) from account_log
    where  1=1
    <include refid="refereeCond"></include>
  </select>

  <resultMap id="RefereeStaRstMap" type="com.verificer.biz.beans.vo.user.ReferrerStaVo">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <result column="referee_count" jdbcType="DECIMAL" property="refereeCount" />
    <result column="total_commission" jdbcType="VARCHAR" property="totalCommission" />
  </resultMap>

  <select id="refereeSta" resultMap="RefereeStaRstMap">
    select
           count(*) as referee_count ,
           ifnull(sum(op_amount),0) as total_commission
    from account_log
    where 1 = 1
      and account_id = #{accountId}
      and op_type = #{opType}

  </select>


  <select id="sumAmount" resultType="java.math.BigDecimal">
    select
           ifnull(sum(op_amount),0) as total_commission
    from account_log
    where 1 = 1
      and account_id = #{accountId}
      and op_type = #{opType}

  </select>



  <sql id="referrerWithdrawCond">
    <if test="accountId != null">
      and account_id = #{accountId}
    </if>
    <if test="opType != null">
      and op_type = #{opType}
    </if>
  </sql>

  <resultMap id="RefererWithdrawRstMap" type="com.verificer.biz.beans.vo.user.UserWithdrawVo">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <result column="amount" jdbcType="DECIMAL" property="amount" />
    <result column="nickname" jdbcType="VARCHAR" property="nickname" />
    <result column="mobile" jdbcType="VARCHAR" property="mobile" />
    <result column="uid" jdbcType="VARCHAR" property="uid" />
  </resultMap>

  <select id="pageReferrerWithdraw" resultMap="RefererWithdrawRstMap">
    select ref.op_amount as amount, u.nickname as nickname ,u.mobile as mobile ,u.uid as uid from
    (
      select * from account_log
      where  1=1
      <include refid="referrerWithdrawCond"></include>
      order by id desc
      limit #{from},#{limit}
    ) as ref
    left join user u on ref.customer_id = u.uid

  </select>

  <select id="countReferrerWithdraw" resultType="int">
    select count(*) from account_log
    where  1=1
    <include refid="referrerWithdrawCond"></include>
  </select>

</mapper>
